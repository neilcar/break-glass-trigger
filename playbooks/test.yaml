- hosts: localhost
  connection: local
  tasks:
    - debug: var=alert_body
    - name: Check existence of ticket
      jira:
        uri: '{{ jira_uri }}'
        username: '{{ jira_user }}'
        password: '{{ jira_pass }}'
        project: '{{ break_glass_annotation.split("-")[0] | upper }}'
        operation: fetch
        issue: '{{ break_glass_annotation }}'
      register: issue
    - name: Show issue
      debug:
        msg: "{{ issue }}"
    - set_fact: ticket_valid="false"
    - name: Set fact if ticket is valid
      set_fact: ticket_valid="true"
      when: 
        - issue.meta.fields.issuetype.name == "Exception"
        - issue.meta.fields.status.name == "In Progress"
    - name: Add comment to ticket
      jira:
        uri: '{{ jira_uri }}'
        username: '{{ jira_user }}'
        password: '{{ jira_pass }}'
        project: '{{ break_glass_annotation.split("-")[0] | upper }}'
        operation: comment
        comment: "Exception used by {{ deployment.namespace }}/{{ deployment.deployment }} at {{ now() }}"
        issue: '{{ break_glass_annotation }}'
      when: ticket_valid="true"

    # - name: Scale down unauthorized deployment
    #   kubernetes:
        